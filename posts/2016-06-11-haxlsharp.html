<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="wf-loading"><head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>How does HaxlSharp work?</title>
    <!--
     <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                displayAlign: "left",
                showProcessingMessages: false,
                showMathMenu: true,
                messageStyle: "none",
                TeX: { TagSide: "left", equationNumbers: { autoNumber: "AMS" } }
            });
        </script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
        </script>
        -->
<script type="text/javascript" src="https://use.typekit.net/geg0pqq.js"></script>
<script type="text/javascript">try{Typekit.load({ async: true });}catch(e){}</script>
   <link rel="stylesheet" type="text/css" href="../css/tufte.css"><style type="text/css">.tk-minion-pro-caption{font-family:"minion-pro-caption",sans-serif;}.tk-minion-pro-display{font-family:"minion-pro-display",serif;}</style><link rel="stylesheet" href="https://use.typekit.net/c/855fba/1w;minion-pro-caption,7ceb210e49ade74e23101e10f006f110a0b6588c7c57777a6e3d98a38b749696,bzc:W:i4,bzb:W:n4,bzj:W:n7;minion-pro-display,7ceb210e49ade74e23101e10f006f110a0b6588c7c57777a6e3d98a38b749696,c0F:W:i4,c0J:W:n4,c0C:W:n7/k" media="only x">
  </head>

  <body><style id="MathJax_CHTML_styles">.mjx-chtml {display: inline-block; line-height: 0; text-indent: 0; text-align: left; text-transform: none; font-style: normal; font-weight: normal; font-size: 100%; font-size-adjust: none; letter-spacing: normal; word-wrap: normal; word-spacing: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; margin: 0; padding: 1px 0}
.MJXc-display {display: block; text-align: center; margin: 1em 0; padding: 0}
.mjx-chtml[tabindex]:focus, body :focus .mjx-chtml[tabindex] {display: inline-table}
.mjx-math {display: inline-block; border-collapse: separate; border-spacing: 0}
.mjx-math * {display: inline-block; text-align: left}
.mjx-numerator {display: block; text-align: center}
.mjx-denominator {display: block; text-align: center}
.MJXc-stacked {height: 0; position: relative}
.MJXc-stacked > * {position: absolute}
.MJXc-bevelled > * {display: inline-block}
.mjx-stack {display: inline-block}
.mjx-op {display: block}
.mjx-under {display: table-cell}
.mjx-over {display: block}
.mjx-over > * {padding-left: 0px!important; padding-right: 0px!important}
.mjx-under > * {padding-left: 0px!important; padding-right: 0px!important}
.mjx-stack > .mjx-sup {display: block}
.mjx-stack > .mjx-sub {display: block}
.mjx-prestack > .mjx-presup {display: block}
.mjx-prestack > .mjx-presub {display: block}
.mjx-delim-h > .mjx-char {display: inline-block}
.mjx-surd {vertical-align: top}
.mjx-mphantom * {visibility: hidden}
.mjx-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 2px 3px; font-style: normal; font-size: 90%}
.mjx-annotation-xml {line-height: normal}
.mjx-menclose > svg {fill: none; stroke: currentColor}
.mjx-mtr {display: table-row}
.mjx-mlabeledtr {display: table-row}
.mjx-mtd {display: table-cell; text-align: center}
.mjx-label {display: block}
.mjx-box {display: inline-block}
.mjx-block {display: block}
.mjx-span {display: span}
.mjx-char {display: block; white-space: pre}
.mjx-itable {display: inline-table}
.mjx-row {display: table-row}
.mjx-cell {display: table-cell}
.mjx-table {display: table; width: 100%}
.mjx-line {display: block; height: 0}
.mjx-strut {width: 0; padding-top: 1em}
.mjx-vsize {width: 0}
.MJXc-space1 {margin-left: .167em}
.MJXc-space2 {margin-left: .222em}
.MJXc-space3 {margin-left: .278em}
.mjx-ex-box-test {position: absolute; width: 1px; height: 60ex}
.MJXc-TeX-unknown-R {font-family: monospace; font-style: normal; font-weight: normal}
.MJXc-TeX-unknown-I {font-family: monospace; font-style: italic; font-weight: normal}
.MJXc-TeX-unknown-B {font-family: monospace; font-style: normal; font-weight: bold}
.MJXc-TeX-unknown-BI {font-family: monospace; font-style: italic; font-weight: bold}
.MJXc-TeX-ams-R {font-family: MJXc-TeX-ams-R,MJXc-TeX-ams-Rw}
.MJXc-TeX-cal-B {font-family: MJXc-TeX-cal-B,MJXc-TeX-cal-Bx,MJXc-TeX-cal-Bw}
.MJXc-TeX-frak-R {font-family: MJXc-TeX-frak-R,MJXc-TeX-frak-Rw}
.MJXc-TeX-frak-B {font-family: MJXc-TeX-frak-B,MJXc-TeX-frak-Bx,MJXc-TeX-frak-Bw}
.MJXc-TeX-math-BI {font-family: MJXc-TeX-math-BI,MJXc-TeX-math-BIx,MJXc-TeX-math-BIw}
.MJXc-TeX-sans-R {font-family: MJXc-TeX-sans-R,MJXc-TeX-sans-Rw}
.MJXc-TeX-sans-B {font-family: MJXc-TeX-sans-B,MJXc-TeX-sans-Bx,MJXc-TeX-sans-Bw}
.MJXc-TeX-sans-I {font-family: MJXc-TeX-sans-I,MJXc-TeX-sans-Ix,MJXc-TeX-sans-Iw}
.MJXc-TeX-script-R {font-family: MJXc-TeX-script-R,MJXc-TeX-script-Rw}
.MJXc-TeX-type-R {font-family: MJXc-TeX-type-R,MJXc-TeX-type-Rw}
.MJXc-TeX-cal-R {font-family: MJXc-TeX-cal-R,MJXc-TeX-cal-Rw}
.MJXc-TeX-main-B {font-family: MJXc-TeX-main-B,MJXc-TeX-main-Bx,MJXc-TeX-main-Bw}
.MJXc-TeX-main-I {font-family: MJXc-TeX-main-I,MJXc-TeX-main-Ix,MJXc-TeX-main-Iw}
.MJXc-TeX-main-R {font-family: MJXc-TeX-main-R,MJXc-TeX-main-Rw}
.MJXc-TeX-math-I {font-family: MJXc-TeX-math-I,MJXc-TeX-math-Ix,MJXc-TeX-math-Iw}
.MJXc-TeX-size1-R {font-family: MJXc-TeX-size1-R,MJXc-TeX-size1-Rw}
.MJXc-TeX-size2-R {font-family: MJXc-TeX-size2-R,MJXc-TeX-size2-Rw}
.MJXc-TeX-size3-R {font-family: MJXc-TeX-size3-R,MJXc-TeX-size3-Rw}
.MJXc-TeX-size4-R {font-family: MJXc-TeX-size4-R,MJXc-TeX-size4-Rw}
@font-face {font-family: MJXc-TeX-ams-R; src: local('MathJax_AMS'), local('MathJax_AMS-Regular')}
@font-face {font-family: MJXc-TeX-ams-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_AMS-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_AMS-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_AMS-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-cal-B; src: local('MathJax_Caligraphic Bold'), local('MathJax_Caligraphic-Bold')}
@font-face {font-family: MJXc-TeX-cal-Bx; src: local('MathJax_Caligraphic'); font-weight: bold}
@font-face {font-family: MJXc-TeX-cal-Bw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Caligraphic-Bold.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Bold.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Bold.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-frak-R; src: local('MathJax_Fraktur'), local('MathJax_Fraktur-Regular')}
@font-face {font-family: MJXc-TeX-frak-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Fraktur-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Fraktur-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Fraktur-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-frak-B; src: local('MathJax_Fraktur Bold'), local('MathJax_Fraktur-Bold')}
@font-face {font-family: MJXc-TeX-frak-Bx; src: local('MathJax_Fraktur'); font-weight: bold}
@font-face {font-family: MJXc-TeX-frak-Bw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Fraktur-Bold.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Fraktur-Bold.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Fraktur-Bold.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-math-BI; src: local('MathJax_Math BoldItalic'), local('MathJax_Math-BoldItalic')}
@font-face {font-family: MJXc-TeX-math-BIx; src: local('MathJax_Math'); font-weight: bold; font-style: italic}
@font-face {font-family: MJXc-TeX-math-BIw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Math-BoldItalic.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Math-BoldItalic.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Math-BoldItalic.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-sans-R; src: local('MathJax_SansSerif'), local('MathJax_SansSerif-Regular')}
@font-face {font-family: MJXc-TeX-sans-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_SansSerif-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_SansSerif-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_SansSerif-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-sans-B; src: local('MathJax_SansSerif Bold'), local('MathJax_SansSerif-Bold')}
@font-face {font-family: MJXc-TeX-sans-Bx; src: local('MathJax_SansSerif'); font-weight: bold}
@font-face {font-family: MJXc-TeX-sans-Bw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_SansSerif-Bold.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_SansSerif-Bold.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_SansSerif-Bold.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-sans-I; src: local('MathJax_SansSerif Italic'), local('MathJax_SansSerif-Italic')}
@font-face {font-family: MJXc-TeX-sans-Ix; src: local('MathJax_SansSerif'); font-style: italic}
@font-face {font-family: MJXc-TeX-sans-Iw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_SansSerif-Italic.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_SansSerif-Italic.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_SansSerif-Italic.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-script-R; src: local('MathJax_Script'), local('MathJax_Script-Regular')}
@font-face {font-family: MJXc-TeX-script-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Script-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Script-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Script-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-type-R; src: local('MathJax_Typewriter'), local('MathJax_Typewriter-Regular')}
@font-face {font-family: MJXc-TeX-type-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Typewriter-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Typewriter-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Typewriter-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-cal-R; src: local('MathJax_Caligraphic'), local('MathJax_Caligraphic-Regular')}
@font-face {font-family: MJXc-TeX-cal-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Caligraphic-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-main-B; src: local('MathJax_Main Bold'), local('MathJax_Main-Bold')}
@font-face {font-family: MJXc-TeX-main-Bx; src: local('MathJax_Main'); font-weight: bold}
@font-face {font-family: MJXc-TeX-main-Bw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Main-Bold.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-main-I; src: local('MathJax_Main Italic'), local('MathJax_Main-Italic')}
@font-face {font-family: MJXc-TeX-main-Ix; src: local('MathJax_Main'); font-style: italic}
@font-face {font-family: MJXc-TeX-main-Iw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Main-Italic.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-main-R; src: local('MathJax_Main'), local('MathJax_Main-Regular')}
@font-face {font-family: MJXc-TeX-main-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Main-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-math-I; src: local('MathJax_Math Italic'), local('MathJax_Math-Italic')}
@font-face {font-family: MJXc-TeX-math-Ix; src: local('MathJax_Math'); font-style: italic}
@font-face {font-family: MJXc-TeX-math-Iw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Math-Italic.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-size1-R; src: local('MathJax_Size1'), local('MathJax_Size1-Regular')}
@font-face {font-family: MJXc-TeX-size1-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Size1-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-size2-R; src: local('MathJax_Size2'), local('MathJax_Size2-Regular')}
@font-face {font-family: MJXc-TeX-size2-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Size2-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-size3-R; src: local('MathJax_Size3'), local('MathJax_Size3-Regular')}
@font-face {font-family: MJXc-TeX-size3-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Size3-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf') format('opentype')}
@font-face {font-family: MJXc-TeX-size4-R; src: local('MathJax_Size4'), local('MathJax_Size4-Regular')}
@font-face {font-family: MJXc-TeX-size4-Rw; src /*1*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/eot/MathJax_Size4-Regular.eot'); src /*2*/: url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff') format('woff'), url('https://cdn.mathjax.org/mathjax/latest/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf') format('opentype')}
</style>
    <main role="main">
    <article class="row article post" role="article">
      <div class="cell">
        <header class="row">
          <div class="home">
            <a href="../">Blog</a>
            <a href="../archive.html">Archive</a>
            <a href="../projects.html">Projects</a>
          </div>
        </header>
          <h1 class="preview-title">How does HaxlSharp work?</h1> 
<div class="preview-info">

<div><i>June 11, 2016</i></div>
</div>
<p>

</p><p>I wrote a C# version of <a href="https://github.com/facebook/Haxl">Haxl</a> called <a href="https://github.com/joashc/HaxlSharp">HaxlSharp</a>. The original Haxl paper by Marlow, et al. is brilliantly titled <em><a href="http://community.haskell.org/~simonmar/papers/haxl-icfp14.pdf">There is no Fork: an Abstraction for Efficient, Concurrent, and Concise Data Access</a></em>, and provides a great overview of Haxl. This post will focus more on the <em>differences</em> between the original Haskell implementation and my C# implementation.</p>
<h2 id="what-is-fetch">What is <code>Fetch&lt;&gt;</code>?</h2>
<p>In HaxlSharp, we use query syntax to combine functions that return <code>Fetch&lt;&gt;</code> objects. Let’s say we have these three <code>Fetch&lt;&gt;</code> objects/ functions:</p>
<div class="sourceCode"><pre class="sourceCode cs"><code class="sourceCode cs">Fetch&lt;<span class="dt">string</span>&gt; a;
Fetch&lt;<span class="dt">int</span>&gt; b;
Func&lt;<span class="dt">string</span>, Fetch&lt;<span class="dt">int</span>&gt;&gt; c;</code></pre></div>
<p>We can combine them like this:</p>
<div class="sourceCode"><pre class="sourceCode cs"><code class="sourceCode cs">from x <span class="kw">in</span> a
from y <span class="kw">in</span> b
from z <span class="kw">in</span> <span class="fu">c</span>(a)
select y + z;</code></pre></div>
<p><code>Fetch&lt;&gt;</code> is actually a free monad that collects lambda expression trees instead of lambda functions.</p>
<p>It divides these expression trees into groups of expressions that can be written applicatively, using a version of the <code>ApplicativeDo</code> algorithm that was recently merged into GHC<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>.</p>
<!--more-->
<h3 id="a-brief-aside-on-applicativedo">A brief aside on <code>ApplicativeDo</code></h3>
<p>If <code>ApplicativeDo</code> finds two monadic bind statements that can be expressed applicatively:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE ApplicativeDo #-}</span>
a <span class="ot">&lt;-</span> x
b <span class="ot">&lt;-</span> y</code></pre></div>
<p>it will rewrite them as:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">(a, b) <span class="ot">&lt;-</span> (,) <span class="fu">&lt;$&gt;</span> x <span class="fu">&lt;*&gt;</span> y</code></pre></div>
<p>Generalizing to more than two statements is trivial. For instance, in this expression:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE ApplicativeDo #-}</span>
a <span class="ot">&lt;-</span> x
b <span class="ot">&lt;-</span> y
c <span class="ot">&lt;-</span> z
d <span class="ot">&lt;-</span> q a b c
e <span class="ot">&lt;-</span> r a c d
<span class="co">-- etc</span></code></pre></div>
<p>the first three statements can be rewritten applicatively:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">(a, b, c) <span class="ot">&lt;-</span> (,,) <span class="fu">&lt;$&gt;</span> x <span class="fu">&lt;*&gt;</span> y <span class="fu">&lt;*&gt;</span> z</code></pre></div>
<p>Because of tuple destructuring and nested lambdas, subsequent monadic binds will have <code>a</code>, <code>b</code>, and <code>c</code> in scope:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">(,,) <span class="fu">&lt;$&gt;</span> x <span class="fu">&lt;*&gt;</span> y <span class="fu">&lt;*&gt;</span> z <span class="fu">&gt;&gt;=</span>
  \(a, b, c) <span class="ot">-&gt;</span> q a b c <span class="fu">&gt;&gt;=</span>
    \d <span class="ot">-&gt;</span> r a c d
      \e <span class="ot">-&gt;</span> <span class="co">--etc</span></code></pre></div>
<p>Here’s where things start to diverge from the Haskell version. C# doesn’t have tuple destructuring, nor does it desugar query expressions into nested lambdas. Overload resolution on nested lambdas has an appalling asymptotic complexity, so the C# compiler desugars query expressions using <em>transparent identifiers</em><a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> that emulate the scoping behaviour of nested lambdas.</p>
<p>Unfortunately, transparent identifiers are meant to be an internal compiler implementation detail, and aren’t really accessible to us as library authors. If we want to mess around with the scoping behaviour of our lambda expressions- which we do if we want to rewrite them applicatively- we need to ditch transparent identifiers completely, and use our own scoping system.</p>
<h3 id="haxlsharp-scoping">HaxlSharp scoping</h3>
<p>In C#, we’d write that <code>ApplicativeDo</code> example like this:</p>
<div class="sourceCode"><pre class="sourceCode cs"><code class="sourceCode cs">from a <span class="kw">in</span> x
from b <span class="kw">in</span> y
from c <span class="kw">in</span> z
from d <span class="kw">in</span> <span class="fu">q</span>(a, b, c)
from e <span class="kw">in</span> <span class="fu">r</span>(a, c, d)</code></pre></div>
<p>Let’s say that these are all of type <code>Fetch&lt;int&gt;</code>. We will get four<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> bind lambda expression trees:</p>
<div class="sourceCode"><pre class="sourceCode cs"><code class="sourceCode cs">Expression&lt;Func&lt;<span class="dt">int</span>, Fetch&lt;<span class="dt">int</span>&gt;&gt;&gt;
bind1 = a =&gt; y;

Expression&lt;Func&lt;<span class="dt">int</span>, <span class="dt">int</span>, Fetch&lt;<span class="dt">int</span>&gt;&gt;&gt;
bind2 = (a, b) =&gt; z;

Expression&lt;Func&lt;TRANS0&lt;<span class="dt">int</span>, <span class="dt">int</span>&gt;, <span class="dt">int</span>, Fetch&lt;<span class="dt">int</span>&gt;&gt;&gt;
bind3 = (ti0, c) =&gt; <span class="fu">q</span>(ti0.<span class="fu">a</span>, ti0.<span class="fu">b</span>, c);

Expression&lt;Func&lt;TRANS1&lt;TRANS0&lt;<span class="dt">int</span>, <span class="dt">int</span>&gt;, <span class="dt">int</span>&gt;, <span class="dt">int</span>, Fetch&lt;<span class="dt">int</span>&gt;&gt;&gt;
bind4 = (ti1, d) =&gt; <span class="fu">r</span>(ti1.<span class="fu">ti0</span>.<span class="fu">a</span>, ti1.<span class="fu">c</span>, d);</code></pre></div>
<p>We can’t really manipulate transparent identifiers, so we rewrite all these expresions to take a <code>Scope</code> object, which is basically a <code>Dictionary&lt;string, object&gt;</code> that can spawn child scopes.</p>
<p>Here’s the expressions rewritten as <code>Expression&lt;Func&lt;Scope, Fetch&lt;int&gt;&gt;&gt;</code>:</p>
<div class="sourceCode"><pre class="sourceCode cs"><code class="sourceCode cs">Expression&lt;Func&lt;Scope, Fetch&lt;<span class="dt">int</span>&gt;&gt;&gt;
bind1 = scope =&gt; y;

Expression&lt;Func&lt;Scope, Fetch&lt;<span class="dt">int</span>&gt;&gt;&gt;
bind2 = scope =&gt; z;

Expression&lt;Func&lt;Scope, Fetch&lt;<span class="dt">int</span>&gt;&gt;&gt;
bind3 = scope =&gt; 
  <span class="fu">q</span>((<span class="dt">int</span>)scope.<span class="fu">Get</span>(<span class="st">"a"</span>), (<span class="dt">int</span>)scope.<span class="fu">Get</span>(<span class="st">"b"</span>), (<span class="dt">int</span>)scope.<span class="fu">Get</span>(<span class="st">"c"</span>));

Expression&lt;Func&lt;Scope, Fetch&lt;<span class="dt">int</span>&gt;&gt;&gt;
bind4 = scope =&gt; 
  <span class="fu">r</span>((<span class="dt">int</span>)scope.<span class="fu">Get</span>(<span class="st">"a"</span>), (<span class="dt">int</span>)scope.<span class="fu">Get</span>(<span class="st">"c"</span>), (<span class="dt">int</span>)scope.<span class="fu">Get</span>(<span class="st">"d"</span>));</code></pre></div>
<p>All transparent identifier and parameter accesses have been replaced with scope accessors.</p>
<p>If we have a nested <code>Fetch&lt;&gt;</code>:</p>
<div class="sourceCode"><pre class="sourceCode cs"><code class="sourceCode cs">var fetch1 = 
  from a <span class="kw">in</span> x
  from b <span class="kw">in</span> y
  from c <span class="kw">in</span> z
  select <span class="fu">tuple</span>(a, b, c);

var fetch2 = 
  from a <span class="kw">in</span> x
  from b <span class="kw">in</span> fetch1
  select <span class="fu">tuple</span>(a, b);</code></pre></div>
<p><code>fetch1</code> will be given a child scope, so it can access the parent variable <code>a</code> without polluting the scope of the parent.</p>
<h3 id="fetching">Fetching</h3>
<p>All our expressions now assume every value they use is present in the scope. We ensure this by running applicative groups concurrently and awaiting their completion. Once the applicative group fetching is complete, we write the results to the scope with their respective variable names, and then pass this populated scope to the next applicative group, and so on.</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>You can check out the proposal <a href="https://ghc.haskell.org/trac/ghc/wiki/ApplicativeDo">here</a>.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>See <em><a href="2016-03-17-select-many-weird.html#the-of-the-show">Why is SelectMany so weird?</a></em> for details on transparent identifiers.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>The initial lambda is simply <code>() =&gt; x</code>.<a href="#fnref3">↩</a></p></li>
</ol>
</div>

<div class="info">
</div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.6/zepto.min.js"></script>
<script type="text/javascript" src="../css/footnote.js"></script>




        <div id="footer">
          <small>Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a></small>
        </div>
      </div>
    </article>
    </main>
  

</body></html>